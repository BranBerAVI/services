version: "3.7"
services:
  # Backend Services
  rabbit:
    image: rabbitmq:3
    ports:
      - "5672:5672"
    volumes:
      - ./configuration/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./configuration/enabled_plugins:/etc/rabbitmq/enabled_plugins
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  redis:
    image: redis
    command: [
      "bash", "-c",
      '
        docker-entrypoint.sh
        --requirepass password
        --appendonly yes
      '
    ]
    volumes:
      - redis:/data
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  # Primitive Services
  project:
    image: nuthan-db.se.rit.edu/samaritan-project
    depends_on:
      - "rabbit"
    environment:
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
      RABBIT_USER: "guest"
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  repository:
    image: nuthan-db.se.rit.edu/samaritan-repository
    volumes:
      - repositories:/samaritan/repositories
    depends_on:
      - "rabbit"
      - "redis"
      - "project"
    environment:
      REPOSITORIES_ROOT: "/samaritan/repositories"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
      RABBIT_USER: "guest"
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_INDEX: "11"
      REDIS_PASSWORD: "password"
    deploy:
      mode: replicated
      replicas: 2
      placement:
        constraints:
          - node.role == manager
  understand:
    image: nuthan-db.se.rit.edu/samaritan-understand
    volumes:
      - repositories:/samaritan/repositories
      - understand:/samaritan/understand
    depends_on:
      - "rabbit"
      - "project"
    environment:
      UNDERSTAND_ROOT: "/samaritan/understand"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
      RABBIT_USER: "guest"
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  # Metric Services
  churn:
    image: nuthan-db.se.rit.edu/samaritan-metrics-churn
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  collaboration:
    image: nuthan-db.se.rit.edu/samaritan-metrics-collaboration
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  contribution:
    image: nuthan-db.se.rit.edu/samaritan-metrics-contribution
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  contributor:
    image: nuthan-db.se.rit.edu/samaritan-metrics-contributor
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  complexity:
    image: nuthan-db.se.rit.edu/samaritan-metrics-complexity
    depends_on:
      - "project"
      - "rabbit"
      - "understand"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  flow:
    image: nuthan-db.se.rit.edu/samaritan-metrics-flow
    depends_on:
      - "project"
      - "rabbit"
      - "understand"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  hunk:
    image: nuthan-db.se.rit.edu/samaritan-metrics-hunk
    depends_on:
      - "project"
      - "rabbit"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  keyword:
    image: nuthan-db.se.rit.edu/samaritan-metrics-keyword
    depends_on:
      - "project"
      - "rabbit"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  loc:
    image: nuthan-db.se.rit.edu/samaritan-metrics-loc
    volumes:
      - repositories:/samaritan/repositories
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  nesting:
    image: nuthan-db.se.rit.edu/samaritan-metrics-nesting
    depends_on:
      - "project"
      - "rabbit"
      - "understand"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  offender:
    image: nuthan-db.se.rit.edu/samaritan-metrics-offender
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
  ownership:
    image: nuthan-db.se.rit.edu/samaritan-metrics-ownership
    depends_on:
      - "rabbit"
      - "repository"
    environment:
      RABBIT_PASSWORD: "guest"
      RABBIT_HEARTBEAT: 600
      RABBIT_USER: "guest"
      RABBIT_HOST: "rabbit"
      RABBIT_PORT: "5672"
    deploy:
      mode: global
      placement:
        constraints:
          - node.role == manager
volumes:
  repositories:
    external: true
  redis:
    external: true
  understand:
    external: true
